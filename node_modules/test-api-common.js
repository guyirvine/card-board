/*
 * INSTRUCTIONS
 *
 * run the site at localhost, port 3000
 *
 * run vows --spec test/api-card.js
 *
 */

var request = require('request'),
    assert = require('assert'),
    apiUrl = "http://localhost:3000/",
    cookie = null


exports.apiTest = function() {
	return {
  general: function( method, url, data, cb ){
    //console.log( 'cb?', cb )
    request(
      {
        method: method,
        url: apiUrl+(url||''),
        json: data || {},
        headers: {Cookie: cookie}
      },
      function(req, res){
        cb( res )
      }
    )
  },
  get: function( url, data, cb  ){ apiTest.general( 'GET', url, data, cb    )  },
  post: function( url, data, cb ){ apiTest.general( 'POST', url, data, cb   )  },
  put: function( url, data, cb  ){ apiTest.general( 'PUT', url, data, cb    )  },
  del: function( url, data, cb  ){ apiTest.general( 'DELETE', url, data, cb )  }
}
}

function apiTestGeneral( method, url, data, cb ){
    //console.log( 'cb?', cb )
    request(
      {
        method: method,
        url: apiUrl+(url||''),
        json: data || {},
        headers: {Cookie: cookie}
      },
      function(req, res){
        cb( res )
      }
    )
  }

exports.get = function( url, data, cb  ){ apiTestGeneral( 'GET', url, data, cb    )  },
exports.post = function( url, data, cb ){ apiTestGeneral( 'POST', url, data, cb   )  },
exports.put = function( url, data, cb  ){ apiTestGeneral( 'PUT', url, data, cb    )  },
exports.del = function( url, data, cb  ){ apiTestGeneral( 'DELETE', url, data, cb )  }


exports.assertStatus = function(code) {
  return function (res, b, c) {
    assert.equal(res.statusCode, code);
  };
}


exports.assertJSONHead = function(){
  return function(res, b, c ){
    assert.equal( res.headers['content-type'], 'application/json; charset=utf-8' )
  }
}

exports.assertValidJSON = function(){
  return function(res, b ){
    // this can either be a Object or Array
    assert.ok( typeof( res.body ) == 'object' )
    //assert.isObject( res.body)
  }
}
